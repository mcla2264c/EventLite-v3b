<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Manager (Firestore)</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. QR Code Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- 3. QR Code Scanning Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- 4. Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for the main script block to access
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, where, serverTimestamp, setLogLevel
        };
    </script>
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        #video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            -webkit-overflow-scrolling: touch; 
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Global Loading Indicator -->
    <div id="globalLoader" class="modal-overlay hidden">
        <div class="loader"></div>
    </div>
    
    <!-- Global Message/Alert -->
    <div id="messageModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <h3 id="messageTitle" class="text-xl font-bold mb-4"></h3>
            <p id="messageText" class="text-gray-700 mb-6"></p>
            <button id="closeMessageModal" class="w-full py-2 px-4 rounded-md text-white font-medium bg-indigo-600 hover:bg-indigo-700">
                OK
            </button>
        </div>
    </div>

    <!-- Admin PIN Modal (Kept for initial UX flow) -->
    <div id="pinModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-center">Admin Access</h3>
            <p class="text-gray-700 mb-4 text-center">Please enter your PIN.</p>
            <form id="pinForm">
                <input type="number" id="pinInput" name="pinInput" maxlength="4" class="mt-1 block w-full text-center text-2xl tracking-[1em] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="----" pattern="\d*">
                <p id="pinError" class="text-red-500 text-sm text-center mt-2 hidden">Invalid PIN.</p>
                <button type="submit" class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Login
                </button>
                <button type="button" id="closePinModal" class="mt-2 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </button>
            </form>
        </div>
    </div>
    
    <!-- Initial Loading/Auth Status -->
    <div id="initialLoading" class="max-w-4xl mx-auto p-8 text-center hidden">
        <p class="text-gray-500">Initializing database connection...</p>
        <div class="loader"></div>
    </div>

    <!-- Main Navigation -->
    <nav id="mainNav" class="bg-white shadow-md hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-2xl font-bold text-indigo-600">EventLite</span>
                </div>
                <div class="flex space-x-4">
                    <!-- Navigation buttons -->
                    <button id="navAdmin" class="nav-btn bg-white text-gray-700 px-3 py-2 rounded-md text-sm font-medium border border-gray-300">Admin</button>
                    <button id="navScanner" class="nav-btn bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium">Scanner</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="mainContent" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        
        <!-- ============================================= -->
        <!-- ADMIN PANEL (Hidden by default)               -->
        <!-- ============================================= -->
        <div id="adminPanel" class="hidden">
             <div class="text-sm text-gray-500 mb-4 p-3 bg-white rounded-lg shadow-sm">
                <p>
                    <span class="font-bold">User ID:</span> 
                    <span id="displayUserId">Loading...</span>
                </p>
            </div>
            <!-- Section 1: Manage Events -->
            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Manage Events</h2>
                <form id="eventForm" class="space-y-4 p-4 border rounded-md mb-6">
                    <h3 class="text-lg font-medium text-gray-900">Create New Event</h3>
                    <div>
                        <label for="eventName" class="block text-sm font-medium text-gray-700">Event Name</label>
                        <input type="text" id="eventName" name="eventName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">Event Date</label>
                        <input type="date" id="eventDate" name="eventDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Event
                    </button>
                </form>

                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Existing Events (Real-Time)</h3>
                    <div id="eventList" class="space-y-3">
                        <p class="text-gray-500">Loading events...</p>
                    </div>
                </div>
            </div>

            <!-- Section 2: Issue Ticket -->
            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. Issue Ticket</h2>
                <form id="ticketForm" class="space-y-4">
                    <div>
                        <label for="eventSelect" class="block text-sm font-medium text-gray-700">Select Event</label>
                        <select id="eventSelect" name="eventSelect" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Loading events...</option>
                        </select>
                    </div>
                    <div>
                        <label for="patronName" class="block text-sm font-medium text-gray-700">Attendee Name</label>
                        <input type="text" id="patronName" name="patronName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="patronEmail" class="block text-sm font-medium text-gray-700">Attendee Email (Ticket will be sent here)</label>
                        <input type="email" id="patronEmail" name="patronEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Issue & Email Ticket
                    </button>
                </form>
            </div>

            <!-- Section 3: Issued Tickets -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">3. Issued Tickets (Real-Time)</h2>
                <div id="ticketList" class="space-y-3">
                    <p class="text-gray-500">Loading tickets...</p>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- SCANNER PANEL (Default View)                  -->
        <!-- ============================================= -->
        <div id="scannerPanel">
            <div class="bg-white shadow-lg rounded-lg p-6 text-center">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ticket Scanner</h2>
                <button id="startScanBtn" class="w-full py-3 px-4 rounded-md text-white font-medium bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mb-4">
                    Start Camera
                </button>
                <div id="scannerUI" class="hidden">
                    <video id="video" playsinline></video>
                    <!-- This canvas is used by jsQR but not shown to the user -->
                    <canvas id="scanCanvas" class="hidden"></canvas>
                    <p id="scanMessage" class="mt-4 text-lg font-medium text-gray-700">Point camera at a ticket QR code...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- TICKET MODAL (Hidden by default)                -->
    <!-- ============================================= -->
    <div id="ticketModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full mx-4 modal-content">
            <h2 class="text-3xl font-bold text-center text-indigo-600 mb-2">Event Ticket</h2>
            <div class="text-center border-b pb-4 mb-4">
                <p id="ticketEventName" class="text-xl font-semibold text-gray-800"></p>
                <p id="ticketEventDate" class="text-sm text-gray-500"></p>
            </div>
            <div class="text-center mb-6">
                <p class="text-lg font-medium text-gray-700">Attendee:</p>
                <p id="ticketPatronName" class="text-2xl font-bold text-gray-900"></p>
            </div>
            
            <!-- QR Code will be generated here -->
            <div id="qrcode" class="flex justify-center items-center w-64 h-64 mx-auto border-4 border-gray-200 rounded-lg p-2"></div>
            
            <p class="text-xs text-gray-400 text-center mt-4" id="ticketIdDisplay"></p>
            
            <button id="closeTicketModal" class="mt-6 w-full py-2 px-4 rounded-md text-white font-medium bg-gray-600 hover:bg-gray-700">
                Close
            </button>
        </div>
    </div>
    
    <!-- ============================================= -->
    <!-- SCAN RESULT MODAL (Hidden by default)           -->
    <!-- ============================================= -->
    <div id="scanResultModal" class="modal-overlay hidden">
         <div id="scanResultCard" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full mx-4 text-center modal-content">
             <!-- Icon will be injected here -->
             <div id="scanResultIcon" class="mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6">
                <!-- e.g., <svg>...</svg> -->
             </div>
             <h3 id="scanResultTitle" class="text-3xl font-bold mb-3"></h3>
             <p id="scanResultMessage" class="text-lg text-gray-700 mb-8"></p>
             <button id="closeScanResultModal" class="w-full py-2 px-4 rounded-md text-white font-medium">
                Scan Next Ticket
             </button>
         </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // ===============================================================
        // === CONFIGURATION (REQUIRED) ==================================
        // ===============================================================
        // 1. Set your Admin PIN (only used for UI login)
        const ADMIN_PIN = '1234'; 

        // 2. Set the URL of the deployed Google Apps Script (Code.gs).
        //    **YOU MUST UPDATE THIS VALUE AFTER DEPLOYMENT** (See README.md).
        const EMAIL_SERVICE_URL = '[https://script.google.com/macros/s/AKfycbyW0N56gYTxM1Rcf8_WXhmOmL0pLv8F_EgWhxkplDoYUIzYR5nWBQzW8g69D6zAOnN9lQ/exec](https://script.google.com/macros/s/AKfycbyW0N56gYTxM1Rcf8_WXhmOmL0pLv8F_EgWhxkplDoYUIzYR5nWBQzW8g69D6zAOnN9lQ/exec)'; 

        // 3. (Optional) Replace with your own sound file URLs
        const VALID_SOUND_URL = 'https://audio.jukehost.co.uk/hwKXRIsgvAjL7B2SWXLMC4CLjiG5wFg3.mp3'; // Success chime
        const INVALID_SOUND_URL = 'https://audio.jukehost.co.uk/zFn82lCNURrv5lY17P0I8FDJMqPDHieS.mp3'; // Error sound
        // ===============================================================
        // ===============================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check for Firebase dependency before proceeding
            if (typeof window.firebase === 'undefined') {
                showMessage('Fatal Error', 'Firebase SDK not loaded. Check internet connection or script import order.');
                return;
            }

            // --- GLOBAL FIREBASE VARIABLES ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig = null;
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Firebase config missing or invalid.", e);
                showMessage('Configuration Error', 'Firebase configuration is missing or invalid.');
                return;
            }

            let app, db, auth;
            let userId = null;
            let isAuthReady = false;
            let eventsCache = []; // Cache to hold event data for ticket creation/lookup

            // --- ADMIN DATA PATHS ---
            const EVENT_COLLECTION_PATH = `artifacts/${appId}/public/data/events`;
            const TICKET_COLLECTION_PATH = `artifacts/${appId}/public/data/tickets`;

            // --- APP STATE ---
            let qrCodeInstance = null;
            let videoStream = null;
            let scanAnimationId = null;

            // --- DOM Elements ---
            const initialLoading = document.getElementById('initialLoading');
            const mainNav = document.getElementById('mainNav');
            const mainContent = document.getElementById('mainContent');
            const navAdmin = document.getElementById('navAdmin');
            const navScanner = document.getElementById('navScanner');
            
            const pinModal = document.getElementById('pinModal');
            const pinForm = document.getElementById('pinForm');
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            const closePinModal = document.getElementById('closePinModal');

            const displayUserId = document.getElementById('displayUserId');
            const eventForm = document.getElementById('eventForm');
            const eventList = document.getElementById('eventList');
            const ticketForm = document.getElementById('ticketForm');
            const eventSelect = document.getElementById('eventSelect');
            const ticketList = document.getElementById('ticketList');
            
            const ticketModal = document.getElementById('ticketModal');
            const closeTicketModal = document.getElementById('closeTicketModal');
            
            const startScanBtn = document.getElementById('startScanBtn');
            const scannerUI = document.getElementById('scannerUI');
            const video = document.getElementById('video');
            const scanCanvasElement = document.getElementById('scanCanvas');
            const scanCanvas = scanCanvasElement.getContext('2d');
            const scanMessage = document.getElementById('scanMessage');

            const scanResultModal = document.getElementById('scanResultModal');
            const scanResultCard = document.getElementById('scanResultCard');
            const scanResultIcon = document.getElementById('scanResultIcon');
            const scanResultTitle = document.getElementById('scanResultTitle');
            const scanResultMessage = document.getElementById('scanResultMessage');
            const closeScanResultModal = document.getElementById('closeScanResultModal');

            const globalLoader = document.getElementById('globalLoader');
            const messageModal = document.getElementById('messageModal');
            const messageTitle = document.getElementById('messageTitle');
            const messageText = document.getElementById('messageText');
            const closeMessageModal = document.getElementById('closeMessageModal');

            // --- ICONS (as SVGs) ---
            const validIcon = `
                <svg class="h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`;
            const invalidIcon = `
                <svg class="h-12 w-12 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`;
            const warningIcon = `
                <svg class="h-12 w-12 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.008v.008H12v-.008Z" />
                </svg>`;

            // --- AUDIO FUNCTIONS (Robust Fix) ---
            
            /** Plays a sound from a URL by creating a new Audio object to avoid conflicts. */
            function playSound(url) {
                if (!url) return;
                try {
                    const audio = new Audio(url);
                    audio.currentTime = 0; // Ensures it plays from the start
                    audio.play().catch(e => console.error("Audio play failed. User interaction may be required.", e));
                } catch (e) {
                    console.error("Could not create audio object:", e);
                }
            }
            function playValid() { playSound(VALID_SOUND_URL); }
            function playInvalid() { playSound(INVALID_SOUND_URL); }


            // --- UTILITY FUNCTIONS ---
            
            function showLoader() { globalLoader.classList.remove('hidden'); }
            function hideLoader() { globalLoader.classList.add('hidden'); }

            function showMessage(title, text) {
                messageTitle.textContent = title;
                messageText.textContent = text;
                messageModal.classList.remove('hidden');
            }
            
            closeMessageModal.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            function getEventById(id) {
                return eventsCache.find(e => e.id === id);
            }

            // --- FIREBASE INITIALIZATION ---

            async function initializeFirebase() {
                initialLoading.classList.remove('hidden');
                
                try {
                    // Set Firestore log level to Debug for visibility
                    firebase.setLogLevel('Debug');
                    
                    app = firebase.initializeApp(firebaseConfig);
                    db = firebase.getFirestore(app);
                    auth = firebase.getAuth(app);
                    
                    // Attempt to sign in with custom token or anonymously
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (initialAuthToken) {
                        await firebase.signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await firebase.signInAnonymously(auth);
                    }

                    // Auth State Change Listener (Sets global state)
                    firebase.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            displayUserId.textContent = userId;
                            isAuthReady = true;
                            
                            // Check hash only after auth is ready
                            if (!checkHash()) {
                                initializeAppLogic();
                            }
                            
                            // Start listening for real-time data
                            startRealTimeListeners();
                        } else {
                            // User is signed out (shouldn't happen in this environment)
                            userId = crypto.randomUUID(); // Fallback ID
                            displayUserId.textContent = userId;
                            isAuthReady = true;
                            if (!checkHash()) {
                                initializeAppLogic();
                            }
                        }
                        initialLoading.classList.add('hidden');
                    });

                } catch (error) {
                    console.error("Firebase Initialization Failed:", error);
                    initialLoading.classList.add('hidden');
                    showMessage('Setup Error', `Firebase initialization failed. Check your config. Error: ${error.message}`);
                }
            }

            function checkHash() {
                const hash = location.hash;
                if (hash.startsWith('#ticket=')) {
                    // isViewerMode is implied when in hash mode
                    initializeTicketViewer(hash.substring(8)); 
                    return true;
                }
                return false;
            }

            function initializeTicketViewer(ticketId) {
                // Hide main app UI, show only ticket modal
                mainNav.classList.add('hidden');
                mainContent.classList.add('hidden');
                viewTicket(ticketId, true); // true for isViewerMode
            }
            
            function initializeAppLogic() {
                mainNav.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                // Show scanner by default
                scannerPanel.classList.remove('hidden');
                navScanner.classList.add('bg-indigo-600', 'text-white');
                navAdmin.classList.remove('bg-indigo-600', 'text-white');
            }
            
            // --- FIREBASE REAL-TIME LISTENERS ---

            function startRealTimeListeners() {
                if (!isAuthReady || !db) return;

                // 1. Events Listener
                firebase.onSnapshot(firebase.collection(db, EVENT_COLLECTION_PATH), (snapshot) => {
                    eventsCache = [];
                    snapshot.docs.forEach(doc => {
                        eventsCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderEventList(eventsCache);
                    renderEventSelect(eventsCache);
                }, (error) => {
                    console.error("Error fetching events:", error);
                    showMessage('Database Error', 'Could not load event data in real-time.');
                });

                // 2. Tickets Listener
                firebase.onSnapshot(firebase.collection(db, TICKET_COLLECTION_PATH), (snapshot) => {
                    const tickets = [];
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const event = getEventById(data.eventId);
                        tickets.push({
                            id: doc.id,
                            ...data,
                            eventName: event ? event.name : 'Unknown Event',
                            eventDate: event ? event.date : 'N/A',
                        });
                    });
                    renderTicketList(tickets);
                }, (error) => {
                    console.error("Error fetching tickets:", error);
                    showMessage('Database Error', 'Could not load ticket data in real-time.');
                });
            }

            // --- NAVIGATION ---
            navAdmin.addEventListener('click', () => {
                pinModal.classList.remove('hidden');
                pinInput.value = '';
                pinInput.focus();
            });

            navScanner.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
                scannerPanel.classList.remove('hidden');
                navAdmin.classList.remove('bg-indigo-600', 'text-white');
                navScanner.classList.add('bg-indigo-600', 'text-white');
                stopScan();
            });

            // --- PIN MODAL LOGIC ---
            closePinModal.addEventListener('click', () => {
                pinModal.classList.add('hidden');
                pinError.classList.add('hidden');
            });

            pinForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (pinInput.value === ADMIN_PIN) {
                    pinModal.classList.add('hidden');
                    pinError.classList.add('hidden');
                    
                    // Switch to admin panel
                    adminPanel.classList.remove('hidden');
                    scannerPanel.classList.add('hidden');
                    navAdmin.classList.add('bg-indigo-600', 'text-white');
                    navScanner.classList.remove('bg-indigo-600', 'text-white');
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                }
            });


            // --- ADMIN DATA RENDERING ---

            function renderEventList(events) {
                eventList.innerHTML = '';
                if (events.length === 0) {
                    eventList.innerHTML = '<p class="text-gray-500">No events created yet.</p>';
                    return;
                }
                events.forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded-lg bg-gray-50 flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${event.name}</p>
                            <p class="text-sm text-gray-600">${event.date}</p>
                        </div>
                        <button data-event-id="${event.id}" class="delete-event-btn text-sm text-red-600 hover:text-red-800 font-medium">
                            Delete
                        </button>
                    `;
                    eventList.appendChild(card);
                });

                // Add listeners to new delete buttons
                document.querySelectorAll('.delete-event-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const eventId = e.target.dataset.eventId;
                        const eventName = e.target.previousElementSibling.firstElementChild.textContent;
                        
                        showLoader();
                        try {
                            // 1. Delete event document
                            await firebase.deleteDoc(firebase.doc(db, EVENT_COLLECTION_PATH, eventId));
                            
                            // 2. Delete all associated tickets (Requires reading first)
                            const q = firebase.query(firebase.collection(db, TICKET_COLLECTION_PATH), firebase.where("eventId", "==", eventId));
                            const snapshot = await firebase.getDocs(q);
                            
                            snapshot.docs.forEach(async (d) => {
                                await firebase.deleteDoc(firebase.doc(db, TICKET_COLLECTION_PATH, d.id));
                            });
                            
                            showMessage('Success', `Event "${eventName}" and all its tickets have been deleted.`);
                        } catch (error) {
                            console.error("Error deleting event:", error);
                            showMessage('Error', `Failed to delete event: ${error.message}`);
                        } finally {
                            hideLoader();
                        }
                    });
                });
            }

            function renderEventSelect(events) {
                eventSelect.innerHTML = '';
                if (events.length === 0) {
                    eventSelect.innerHTML = '<option value="">Create an event first...</option>';
                    return;
                }
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} (${event.date})`;
                    eventSelect.appendChild(option);
                });
            }

            function renderTicketList(tickets) {
                ticketList.innerHTML = '';
                if (tickets.length === 0) {
                    ticketList.innerHTML = '<p class="text-gray-500">No tickets issued yet.</p>';
                    return;
                }
                
                // Sort by creation time, newest first (if available)
                tickets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                tickets.forEach(ticket => {
                    const scannedAtText = ticket.scannedAt ? new Date(ticket.scannedAt.seconds * 1000).toLocaleString() : 'N/A';
                    const statusClass = ticket.scanned ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = ticket.scanned ? `SCANNED at ${scannedAtText}` : 'NOT SCANNED';

                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-lg bg-gray-50 flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <p class="font-bold text-lg text-gray-800">${ticket.patronName}</p>
                            <p class="text-sm text-gray-600">${ticket.eventName} (${ticket.eventDate})</p>
                        </div>
                        <div class="text-right">
                             <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span>
                             <button data-ticket-id="${ticket.id}" class="view-ticket-btn mt-2 text-sm text-indigo-600 hover:text-indigo-800">View QR</button>
                        </div>
                    `;
                    ticketList.appendChild(card);
                });

                // Add event listeners to new buttons
                document.querySelectorAll('.view-ticket-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewTicket(btn.dataset.ticketId));
                });
            }

            // --- Firestore: Create Event ---
            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();

                const eventName = document.getElementById('eventName').value;
                const eventDate = document.getElementById('eventDate').value;
                
                try {
                    await firebase.addDoc(firebase.collection(db, EVENT_COLLECTION_PATH), {
                        name: eventName,
                        date: eventDate,
                        createdAt: firebase.serverTimestamp()
                    });
                    
                    showMessage('Success', `Event "${eventName}" created!`);
                    eventForm.reset();
                } catch (error) {
                    console.error("Error creating event:", error);
                    showMessage('Error', `Failed to create event: ${error.message}`);
                } finally {
                    hideLoader();
                }
            });

            // --- Email Service Call ---

            async function sendTicketEmail(ticketId, patronName, patronEmail, event, ticketLink) {
                if (EMAIL_SERVICE_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    console.warn("Email service URL is not configured. Skipping email.");
                    showMessage('Ticket Issued (NO EMAIL)', `Ticket issued for ${patronName}. You MUST deploy the new Google Apps Script and update EMAIL_SERVICE_URL to enable emailing. Ticket Link: ${ticketLink}`);
                    return false;
                }

                try {
                    // This call relies on the Google Apps Script acting as a POST endpoint
                    const response = await fetch(EMAIL_SERVICE_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Required for simple web app deployments
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticketId,
                            patronName,
                            patronEmail,
                            eventName: event.name,
                            eventDate: event.date,
                            ticketLink
                        })
                    });

                    // Due to 'no-cors', we can't reliably read the response status/body, 
                    // but a successful fetch() implies the request was sent.
                    console.log("Email service call initiated via Apps Script.");
                    showMessage('Success', `Ticket issued for ${patronName}! \n\nTicket link sent to ${patronEmail} via Google Apps Script.`);
                    return true;

                } catch (error) {
                    console.error("Error calling email service:", error);
                    showMessage('Ticket Issued (EMAIL FAILED)', `Ticket issued for ${patronName}, but sending the email failed. Check the Apps Script URL and deployment. Ticket Link: ${ticketLink}`);
                    return false;
                }
            }


            // --- Firestore: Issue Ticket ---
            ticketForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();

                const eventId = eventSelect.value;
                const patronName = document.getElementById('patronName').value;
                const patronEmail = document.getElementById('patronEmail').value;

                if (!eventId) {
                    showMessage('Error', 'Please select an event.');
                    hideLoader();
                    return;
                }
                
                const event = getEventById(eventId);
                if (!event) {
                    showMessage('Error', 'Selected event not found in local cache.');
                    hideLoader();
                    return;
                }

                try {
                    // 1. Create the ticket document in Firestore (Primary function)
                    const newTicketRef = await firebase.addDoc(firebase.collection(db, TICKET_COLLECTION_PATH), {
                        eventId, 
                        patronName, 
                        patronEmail,
                        scanned: false,
                        scannedAt: null,
                        createdAt: firebase.serverTimestamp()
                    });
                    
                    const ticketId = newTicketRef.id;
                    const publicAppUrl = window.location.origin + window.location.pathname;
                    const ticketLink = `${publicAppUrl}#ticket=${ticketId}`;
                    
                    // 2. Call the email service (Secondary function)
                    await sendTicketEmail(ticketId, patronName, patronEmail, event, ticketLink);
                    
                    ticketForm.reset();
                } catch (error) {
                    console.error("Error issuing ticket:", error);
                    showMessage('Error', `Failed to issue ticket: ${error.message}`);
                } finally {
                    hideLoader();
                }
            });
            
            // --- Firestore: View Ticket (QR Code) ---
            async function viewTicket(ticketId, isViewerMode = false) {
                showLoader();
                try {
                    const ticketDoc = await firebase.getDoc(firebase.doc(db, TICKET_COLLECTION_PATH, ticketId));

                    if (!ticketDoc.exists()) {
                        throw new Error("Ticket not found.");
                    }
                    
                    const ticket = { id: ticketDoc.id, ...ticketDoc.data() };
                    const event = getEventById(ticket.eventId);

                    // Populate modal
                    document.getElementById('ticketEventName').textContent = event ? event.name : 'Unknown Event';
                    document.getElementById('ticketEventDate').textContent = event ? event.date : 'N/A';
                    document.getElementById('ticketPatronName').textContent = ticket.patronName;
                    document.getElementById('ticketIdDisplay').textContent = `Ticket ID: ${ticket.id}`;
                    
                    // Generate QR Code
                    const qrcodeContainer = document.getElementById('qrcode');
                    qrcodeContainer.innerHTML = ''; // Clear previous QR code
                    
                    new QRCode(qrcodeContainer, {
                        text: ticket.id,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    if (isViewerMode) {
                        closeTicketModal.style.display = 'none';
                    } else {
                        closeTicketModal.style.display = 'block';
                    }

                    ticketModal.classList.remove('hidden');

                } catch (error) {
                    console.error("Error viewing ticket:", error);
                    if (isViewerMode) {
                        mainNav.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        mainContent.innerHTML = `
                            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                                <h2 class="text-2xl font-semibold text-red-600 mb-4">Ticket Not Found</h2>
                                <p class="text-gray-700 mb-4">The ticket ID "${ticketId}" is invalid or could not be found.</p>
                                <p class="text-gray-700">Please check the link and try again.</p>
                            </div>
                        `;
                    } else {
                        showMessage('Error', `Failed to retrieve ticket: ${error.message}`);
                    }
                } finally {
                    hideLoader();
                }
            }

            closeTicketModal.addEventListener('click', () => {
                ticketModal.classList.add('hidden');
            });


            // --- SCANNER PANEL LOGIC ---

            startScanBtn.addEventListener('click', () => {
                startScan();
            });

            async function startScan() {
                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = videoStream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    
                    startScanBtn.classList.add('hidden');
                    scannerUI.classList.remove('hidden');
                    scanMessage.textContent = 'Point camera at a ticket QR code...';
                    
                    scanAnimationId = requestAnimationFrame(tick);
                } catch (err) {
                    console.error("Camera error:", err);
                    scanMessage.textContent = 'Could not access camera.';
                    showMessage('Camera Error', 'Could not access camera. Please check permissions and try again.');
                }
            }

            function stopScan() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                if (scanAnimationId) {
                    cancelAnimationFrame(scanAnimationId);
                    scanAnimationId = null;
                }
                startScanBtn.classList.remove('hidden');
                scannerUI.classList.add('hidden');
            }

            function tick() {
                if (!videoStream) return; // Stop if stream is closed

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    scanCanvasElement.height = video.videoHeight;
                    scanCanvasElement.width = video.videoWidth;
                    scanCanvas.drawImage(video, 0, 0, scanCanvasElement.width, scanCanvasElement.height);
                    
                    const imageData = scanCanvas.getImageData(0, 0, scanCanvasElement.width, scanCanvasElement.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        verifyTicket(code.data);
                        stopScan(); // Stop scanning to prevent multiple triggers
                        return;
                    }
                }
                scanAnimationId = requestAnimationFrame(tick);
            }

            async function verifyTicket(ticketId) {
                showLoader();
                try {
                    const ticketRef = firebase.doc(db, TICKET_COLLECTION_PATH, ticketId);
                    const ticketDoc = await firebase.getDoc(ticketRef);
                    
                    if (!ticketDoc.exists()) {
                        showScanResult('invalid', 'Invalid Ticket', `Ticket ID ${ticketId} not found.`);
                        return;
                    }
                    
                    const ticketData = ticketDoc.data();
                    const event = getEventById(ticketData.eventId);
                    const eventName = event ? event.name : 'Unknown Event';
                    const patronName = ticketData.patronName;

                    if (ticketData.scanned) {
                        // Ticket already scanned (Warning)
                        const scanTime = ticketData.scannedAt ? new Date(ticketData.scannedAt.seconds * 1000).toLocaleString() : 'an unknown time';
                        showScanResult('warning', 'Already Scanned', `${patronName}'s ticket was already scanned at ${scanTime}.`);
                    } else {
                        // Ticket is valid and not scanned (Success)
                        await firebase.updateDoc(ticketRef, {
                            scanned: true,
                            scannedAt: firebase.serverTimestamp()
                        });
                        
                        // The UI will update automatically via the onSnapshot listener
                        showScanResult('valid', 'Ticket Valid', `${patronName} checked in for ${eventName}.`);
                    }
                } catch (error) {
                    console.error("Firestore Scan Error:", error);
                    showScanResult('invalid', 'Verification Error', `Failed to connect to database. ${error.message}`);
                } finally {
                    hideLoader();
                }
            }

            function showScanResult(type, title, message) {
                scanResultTitle.textContent = title;
                scanResultMessage.textContent = message;
                
                scanResultCard.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500');
                closeScanResultModal.classList.remove('bg-green-600', 'bg-red-600', 'bg-yellow-600', 'hover:bg-green-700', 'hover:bg-red-700', 'hover:bg-yellow-700');

                if (type === 'valid') {
                    playValid();
                    scanResultIcon.innerHTML = validIcon;
                    scanResultCard.classList.add('border-green-500');
                    closeScanResultModal.classList.add('bg-green-600', 'hover:bg-green-700');
                } else if (type === 'invalid') {
                    playInvalid();
                    scanResultIcon.innerHTML = invalidIcon;
                    scanResultCard.classList.add('border-red-500');
                    closeScanResultModal.classList.add('bg-red-600', 'hover:bg-red-700');
                } else { // warning
                    playInvalid();
                    scanResultIcon.innerHTML = warningIcon;
                    scanResultCard.classList.add('border-yellow-500');
                    closeScanResultModal.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                }
                
                scanResultModal.classList.remove('hidden');
            }
            
            closeScanResultModal.addEventListener('click', () => {
                scanResultModal.classList.add('hidden');
                // The user needs to click 'Start Camera' again to resume scanning
            });


            // --- START THE APP ---
            initializeFirebase();
        });
    </script>
</body>
</html>

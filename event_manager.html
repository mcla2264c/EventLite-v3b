<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventLite Manager</title>
    <!-- Firebase and QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- PapaParse for CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* * NOTE: Renamed classes to fix browser caching issues
         * that prevented the top-bar layout from loading.
         */
        :root {
            --primary-color: #4A90E2; /* A modern blue */
            --light-color: #ffffff;
            --dark-color: #333;
            --grey-color: #f4f7f6;
            --mid-grey-color: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warn-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--grey-color);
            color: var(--dark-color);
            margin: 0;
            display: flex; /* Added for sticky footer */
            flex-direction: column; /* Added for sticky footer */
            min-height: 100vh; /* Added for sticky footer */
        }
        
        /* New Footer Style */
        .footer {
            background-color: var(--mid-grey-color);
            color: #777;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            margin-top: auto; /* Pushes footer to bottom */
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .loader {
            border: 4px solid var(--grey-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Main app container fills remaining height */
        #appContainer {
            display: none;
            flex: 1; 
            font-size: 1.5rem;
            flex-direction: column;
        }
        
        /* Header/Nav (RENAMED to bust cache) */
        .app-header {
            background: var(--light-color);
            padding: 15px 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        nav.main-nav {
            display: flex;
            gap: 10px;
        }
        nav.main-nav button {
            background: transparent;
            color: #555;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        nav.main-nav button:hover {
            background-color: var(--grey-color);
        }
        nav.main-nav button.active {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        
        /* Ticket View Mode: Hide Header */
        body.ticket-view-mode .app-header {
            display: none;
        }
        /* Ticket View Mode: Hide Footer */
        body.ticket-view-mode .footer {
            display: none;
        }

        .container {
            flex: 1; /* Make container fill remaining space */
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
            width: 100%;
        }
        
        .app-view {
            display: none;
        }

        /* Card styles */
        .card {
            background: var(--light-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px 30px;
            margin-bottom: 30px;
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 1px solid var(--mid-grey-color);
            border-radius: 8px;
            background-color: #fcfcfc;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        /* Button styles */
        button {
            background-color: var(--primary-color);
            color: var(--light-color);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover {
            background-color: #3a7bc8;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #b02a37; }
        button.small { padding: 5px 10px; font-size: 0.8rem; }
        
        /* PIN Pad */
        #pinView .card {
            max-width: 300px;
            margin: 40px auto;
            text-align: center;
        }
        #pinDisplay {
            height: 50px;
            background: var(--grey-color);
            border: 1px solid var(--mid-grey-color);
            border-radius: 8px;
            margin: 20px 0;
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-color);
        }
        #pinPad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        #pinPad button {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--mid-grey-color);
            font-size: 1.5rem;
            font-weight: 500;
            padding: 20px 0;
            transition: background-color 0.2s;
        }
        #pinPad button:hover {
            background-color: var(--grey-color);
        }
        
        /* Sub-navigation (Admin Tabs) */
        .sub-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--mid-grey-color);
            margin-bottom: 30px;
        }
        .admin-tab-btn {
            background: none;
            color: #777;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-bottom: 4px solid transparent;
            transform: translateY(2px);
        }
        .admin-tab-btn.active {
            color: var(--primary-color);
            border-bottom: 4px solid var(--primary-color);
        }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }

        /* List styles */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--grey-color);
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item-content h3 {
            margin: 0 0 5px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .list-item-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
        }
        .qr-code-container {
            border: 2px solid var(--grey-color);
            border-radius: 8px;
            padding: 10px;
            width: 148px; /* 128px + 10px padding * 2 */
            height: 148px;
        }

        /* CSV Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--grey-color);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-inner {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Scanner */
        #videoContainer {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: #000;
        }
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        #scanResult {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            color: var(--light-color);
            transition: background-color 0.3s;
        }
        #scanResult.info { background-color: var(--primary-color); }
        #scanResult.success { background-color: var(--success-color); }
        #scanResult.warn { background-color: var(--warn-color); color: #333; }
        #scanResult.error { background-color: var(--danger-color); }

        /* Ticket View */
        #ticketView {
            max-width: 500px;
            margin: 20px auto;
        }
        #ticketDetails {
            background: var(--light-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 30px;
            text-align: center;
        }
        #ticketQRCode {
            margin: 25px auto;
            padding: 20px;
            background: var(--light-color);
            border: 4px solid var(--grey-color);
            border-radius: 8px;
            display: inline-block;
        }
        #ticketStatus {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        #ticketStatus.valid {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }
        #ticketStatus.invalid {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

    </style>
</head>
<body>
    
    <!-- Loading Screen -->
    <div id="loadingView" class="loading-container">
        <div class="loader"></div>
        <p>Initializing...</p>
    </div>

    <!-- Main App Container (Hidden by default) -->
    <div id="appContainer" style="display: none;">
        
        <header class="app-header">
            <h1 class="app-logo"><strong>Event</strong><span style="font-weight: 500;">Lite</span></h1>
            <nav id="mainNav" class="main-nav">
                <button id="navAdmin">Admin</button>
                <button id="navScanner">Scanner</button>
            </nav>
        </header>

        <div class="container">
            <!-- PIN View -->
            <div id="pinView" class="app-view">
                <div class="card">
                    <h2>Admin Access</h2>
                    <p>Enter PIN to access the admin panel.</p>
                    <div id="pinDisplay"></div>
                    <div id="pinPad">
                        <button>1</button><button>2</button><button>3</button>
                        <button>4</button><button>5</button><button>6</button>
                        <button>7</button><button>8</button><button>9</button>
                        <button id="pinClear">C</button><button>0</button><button id="pinDelete">âŒ«</button>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="app-view">
                <h1>Admin Panel</h1>
                
                <nav class="sub-nav">
                    <button class="admin-tab-btn active" data-tab="tab-manage">Manage Events</button>
                    <button class="admin-tab-btn" data-tab="tab-issue">Issue Tickets</button>
                    <button class="admin-tab-btn" data-tab="tab-view">View Issued Tickets</button>
                </nav>

                <!-- Admin Tab: Manage Events -->
                <div id="tab-manage" class="admin-tab-content active">
                    <div class="card">
                        <h2>Create New Event</h2>
                        <div class="form-group">
                            <label for="eventName">Event Name</label>
                            <input type="text" id="eventName" placeholder="e.g., Summer Concert">
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Event Date</label>
                            <input type="date" id="eventDate" class="form-group">
                        </div>
                        <button id="createEventBtn">Create Event</button>
                    </div>
                    
                    <div class="card">
                        <h2>Existing Events</h2>
                        <div id="eventListLoader" class="loader" style="display: none;"></div>
                        <div id="eventList"></div>
                    </div>
                </div>

                <!-- Admin Tab: Issue Ticket -->
                <div id="tab-issue" class="admin-tab-content">
                    <div class="card">
                        <h2>Issue New Ticket(s)</h2>
                        <div class="form-group">
                            <label for="eventSelect">Select Event</label>
                            <select id="eventSelect" class="form-group" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="patronName">Patron Name</label>
                            <input type="text" id="patronName" placeholder="e.g., Jane Doe">
                        </div>
                        <div class="form-group">
                            <label for="patronEmail">Patron Email</label>
                            <input type="email" id="patronEmail" placeholder="e.g., jane.doe@example.com">
                        </div>
                        <!-- New Quantity Field -->
                        <div class="form-group">
                            <label for="patronQuantity">Quantity</label>
                            <input type="number" id="patronQuantity" value="1" min="1" max="50" class="form-group">
                        </div>
                        <button id="issueTicketBtn">Issue Ticket(s) & Send Email</button>
                    </div>
                    
                    <!-- New CSV Upload Card -->
                    <div class="card">
                        <h2>Bulk Issue from CSV</h2>
                        <p>Select the event above, then upload a CSV file. Columns must be in this order: <strong>Name, Email, Quantity</strong></p>
                        <div class="form-group">
                            <label for="csvFile">Upload CSV File (.csv)</label>
                            <input type="file" id="csvFile" accept=".csv" class="form-group">
                        </div>
                        <button id="processCsvBtn">Process CSV & Send Tickets</button>
                        <div id="csvProgress">
                            <!-- Progress will be shown here -->
                        </div>
                    </div>
                </div>
                
                <!-- Admin Tab: View Issued Tickets -->
                <div id="tab-view" class="admin-tab-content">
                    <div class="card">
                        <h2>Issued Tickets</h2>
                        <div class="form-group">
                            <label for="eventFilterSelect">Filter by Event</label>
                            <select id="eventFilterSelect" class="form-group" style="width: 100%;"></select>
                        </div>
                        <div id="ticketListLoader" class="loader" style="display: none;"></div>
                        <div id="issuedTicketsList"></div>
                    </div>
                </div>

            </div>

            <!-- Scanner View -->
            <div id="scannerView" class="app-view">
                <!-- Header "Ticket Scanner" removed -->
                <div id="videoContainer">
                    <video id="video" playsinline></video>
                    <div id="scanOverlay"></div>
                </div>
                <!-- Status bar is now always visible -->
                <div id="scanResult" class="info">Ready to scan</div>
            </div>

            <!-- Ticket View (Accessed by URL) -->
            <div id="ticketView" class="app-view">
                <div id="ticketDetailsLoader" class="loader"></div>
                <div id="ticketDetails" style="display: none;">
                    <h1 id="ticketEventName" style="color: var(--primary-color);"></h1>
                    <p id="ticketEventDate" style="font-size: 1.2rem; margin-top: -15px;"></p>
                    <h3 id="ticketPatronName"></h3>
                    <p id="ticketIdDisplay" style="font-size: 0.9rem; color: #777;"></p>
                    <div id="ticketQRCode"></div>
                    <div id="ticketStatus"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Footer -->
    <footer class="footer">
        MVC DBA EventLite 2025
    </footer>

    <!-- 
      FIX: Merged both module scripts into one. 
      This guarantees imports load before the app code runs.
    -->
    <script type="module">
        
        // FIX: Wait for the DOM to be fully loaded before running any script
        window.addEventListener('DOMContentLoaded', () => {

            // --- 1. FIREBASE SDK IMPORTS ---
            
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            import { 
                getFirestore, collection, addDoc, getDocs, doc, deleteDoc,
                onSnapshot, query, where, getDoc, updateDoc, serverTimestamp,
                writeBatch
            } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
            import { 
                getAuth, signInWithCustomToken 
            } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
            
            // Expose necessary Firebase functions to the global scope for the rest of the script
            const firebase = {
                initializeApp,
                getFirestore, collection, addDoc, getDocs, doc, deleteDoc,
                onSnapshot, query, where, getDoc, updateDoc, serverTimestamp,
                writeBatch,
                getAuth, signInWithCustomToken
            };
            window.firebase = firebase; // Also attach to window for any legacy needs

            // --- 2. APPLICATION CODE ---

            // --- CONFIGURATION ---
            
            // =========================================================================
            //  IMPORTANT: PASTE YOUR FIREBASE CONFIG OBJECT HERE
            // =========================================================================
            // To prevent a `SyntaxError: Unexpected token '{` error:
            // 1. DO NOT delete `const CUSTOM_FIREBASE_CONFIG =`
            // 2. Paste your object from the Firebase console *after* the equals sign.
            //
            // It should look like this:
            // const CUSTOM_FIREBASE_CONFIG = {
            //   apiKey: "AIza...",
            //   authDomain: "your-project.firebaseapp.com",
            //   ...
            // };
            // =========================================================================
            const CUSTOM_FIREBASE_CONFIG = {
                apiKey: "AIzaSyAZz-onz-MM__70UAM-8bUoZKwNCZ19fAc",
                authDomain: "eventlite-7604d.firebaseapp.com",
                projectId: "eventlite-7604d",
                storageBucket: "eventlite-7604d.firebasestorage.app",
                messagingSenderId: "348947151704",
                appId: "1:348947151704:web:b94c3ed340cc81983e432d",
                measurementId: "G-8PWJTVY2GB"
            };
            
            const EMAIL_SERVICE_URL = "https://script.google.com/macros/s/AKfycbyW0N56gYTxM1Rcf8_WXhmOmL0pLv8F_EgWhxkplDoYUIzYR5nWBQzW8g69D6zAOnN9lQ/exec";
            const ADMIN_PIN = "1234";

            const SOUND_VALID_URL = "https://audio.jukehost.co.uk/hwKXRIsgvAjL7B2SWXLMC4CLjiG5wFg3.mp3";
            const SOUND_INVALID_URL = "https://audio.jukehost.co.uk/zFn82lCNURrv5lY17P0I8FDJMqPDHieS.mp3";
            // --- END CONFIGURATION ---

            // --- AUDIO FIX: Preload audio elements ---
            const audioValid = new Audio(SOUND_VALID_URL);
            const audioInvalid = new Audio(SOUND_INVALID_URL);
            audioValid.load(); // Start loading the files
            audioInvalid.load(); // Start loading the files
            // --- End Audio Fix ---

            // Global state
            let db;
            let auth;
            let currentEventUnsubscribe = null;
            let currentTicketUnsubscribe = null;
            let currentView = 'admin';
            let scanner = null;
            let isScanning = false;

            /**
             * Robust sound player.
             * Uses pre-loaded audio elements for better mobile reliability.
             */
            function playSound(type) {
                try {
                    if (type === 'valid') {
                        audioValid.currentTime = 0;
                        audioValid.play().catch(e => console.error("Valid audio play error:", e));
                    } else if (type === 'invalid') {
                        audioInvalid.currentTime = 0;
                        audioInvalid.play().catch(e => console.error("Invalid audio play error:", e));
                    }
                } catch (error) {
                    console.error("Audio playback error:", error);
                }
            }

            // DOM Elements
            const loadingView = document.getElementById('loadingView');
            const appContainer = document.getElementById('appContainer');
            const navAdmin = document.getElementById('navAdmin');
            const navScanner = document.getElementById('navScanner');
            const pinView = document.getElementById('pinView');
            const adminView = document.getElementById('adminView');
            const scannerView = document.getElementById('scannerView');
            const ticketView = document.getElementById('ticketView');
            const allViews = document.querySelectorAll('.app-view');
            
            const pinDisplay = document.getElementById('pinDisplay');
            const pinPad = document.getElementById('pinPad');
            
            const adminTabButtons = document.querySelectorAll('.admin-tab-btn');
            const adminTabContents = document.querySelectorAll('.admin-tab-content');
            
            const createEventBtn = document.getElementById('createEventBtn');
            const eventNameInput = document.getElementById('eventName');
            const eventDateInput = document.getElementById('eventDate');
            const eventList = document.getElementById('eventList');
            const eventListLoader = document.getElementById('eventListLoader');
            
            const issueTicketBtn = document.getElementById('issueTicketBtn');
            const eventSelect = document.getElementById('eventSelect');
            const patronNameInput = document.getElementById('patronName');
            const patronEmailInput = document.getElementById('patronEmail');
            const patronQuantityInput = document.getElementById('patronQuantity'); // New quantity input
            
            const csvFileInput = document.getElementById('csvFile'); // New CSV elements
            const processCsvBtn = document.getElementById('processCsvBtn');
            const csvProgress = document.getElementById('csvProgress');
            
            const eventFilterSelect = document.getElementById('eventFilterSelect');
            const issuedTicketsList = document.getElementById('issuedTicketsList');
            const ticketListLoader = document.getElementById('ticketListLoader');
            
            const video = document.getElementById('video');
            const scanResult = document.getElementById('scanResult');
            
            const ticketDetailsLoader = document.getElementById('ticketDetailsLoader');
            const ticketDetails = document.getElementById('ticketDetails');
            const ticketEventName = document.getElementById('ticketEventName');
            const ticketEventDate = document.getElementById('ticketEventDate');
            const ticketPatronName = document.getElementById('ticketPatronName');
            const ticketIdDisplay = document.getElementById('ticketIdDisplay');
            const ticketQRCode = document.getElementById('ticketQRCode');
            const ticketStatus = document.getElementById('ticketStatus');

            /**
             * Initialize Firebase Connection
             */
            async function initFirebase() {
                try {
                    let config = window.__firebase_config;
                    let token = window.__initial_auth_token;

                    if (!config || !token) {
                        console.log("Environment config not found. Using CUSTOM_FIREBASE_CONFIG.");
                        if (CUSTOM_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
                            throw new Error("Firebase config is not set. Please edit CUSTOM_FIREBASE_CONFIG in the HTML file.");
                        }
                        config = CUSTOM_FIREBASE_CONFIG;
                        token = null; 
                    }

                    // Use the imported 'firebase' object
                    const app = firebase.initializeApp(config);
                    db = firebase.getFirestore(app);
                    auth = firebase.getAuth(app);
                    
                    if(token) {
                        await firebase.signInWithCustomToken(auth, token);
                        console.log("Firebase Authentication successful (Token).");
                    } else {
                        console.log("Firebase initialized (Self-hosted). App will rely on Security Rules.");
                    }

                    loadingView.style.display = 'none';
                    appContainer.style.display = 'flex'; // Use flex to position footer
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const ticketId = urlParams.get('ticket');
                    const eventId = urlParams.get('event');

                    if (ticketId && eventId) {
                        document.body.classList.add('ticket-view-mode'); 
                        navigateTo('ticket');
                        loadTicketData(eventId, ticketId);
                    } else {
                        document.body.classList.remove('ticket-view-mode');
                        navigateTo('admin');
                    }
                    
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    loadingView.innerHTML = `<p style="color: red; text-align: center;"><b>Firebase Initialization Error:</b><br>${error.message}<br><br>Please ensure you have correctly pasted your Firebase configuration and set up your Firestore Security Rules.</p>`;
                }
            }

            /**
             * Navigation
             */
            function navigateTo(view) {
                allViews.forEach(v => v.style.display = 'none');
                stopScanner();
                
                navAdmin.classList.remove('active');
                navScanner.classList.remove('active');

                currentView = view;
                if (view === 'admin') {
                    navAdmin.classList.add('active');
                    pinView.style.display = 'block';
                    pinDisplay.textContent = "";
                } else if (view === 'scanner') {
                    navScanner.classList.add('active');
                    scannerView.style.display = 'block';
                    
                    // --- AUDIO FIX: Prime audio on user tap ---
                    audioValid.load();
                    audioInvalid.load();
                    // --- End Audio Fix ---

                    startScanner(); // Auto-start scanner
                } else if (view === 'ticket') {
                    ticketView.style.display = 'block';
                }
            }
            
            navAdmin.addEventListener('click', () => navigateTo('admin'));
            navScanner.addEventListener('click', () => navigateTo('scanner'));

            /**
             * PIN Pad Logic
             */
            pinPad.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') return;
                const key = e.target.textContent;
                let currentPin = pinDisplay.textContent;

                if (e.target.id === 'pinDelete') {
                    pinDisplay.textContent = currentPin.slice(0, -1);
                } else if (e.target.id === 'pinClear') {
                    pinDisplay.textContent = "";
                } else if (currentPin.length < 6) {
                    pinDisplay.textContent += key;
                }

                if (pinDisplay.textContent === ADMIN_PIN) {
                    showAdminPanel();
                }
            });

            function showAdminPanel() {
                pinView.style.display = 'none';
                adminView.style.display = 'block';
                loadEvents();
            }

            /**
             * Admin: Tabbed Navigation
             */
            adminTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    adminTabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    adminTabContents.forEach(content => {
                        content.style.display = (content.id === tabId) ? 'block' : 'none';
                    });
                });
            });

            /**
             * Admin: Event Management
             */
            async function loadEvents() {
                if (!db) return;
                eventListLoader.style.display = 'block';
                eventList.innerHTML = '';
                eventSelect.innerHTML = '<option value="">-- Select an Event --</option>';
                eventFilterSelect.innerHTML = '<option value="all">All Events</option>';

                try {
                    if (currentEventUnsubscribe) currentEventUnsubscribe();
                    const eventsRef = firebase.collection(db, "events");
                    
                    currentEventUnsubscribe = firebase.onSnapshot(eventsRef, (querySnapshot) => {
                        eventListLoader.style.display = 'none';
                        eventList.innerHTML = '';
                        eventSelect.innerHTML = '<option value="">-- Select an Event --</option>';
                        eventFilterSelect.innerHTML = '<option value="all">All Events</option>';
                        
                        if (querySnapshot.empty) {
                            eventList.innerHTML = '<p>No events found. Create one above.</p>';
                            return;
                        }

                        querySnapshot.forEach((doc) => {
                            const event = { id: doc.id, ...doc.data() };
                            
                            const eventEl = document.createElement('div');
                            eventEl.className = 'list-item';
                            eventEl.innerHTML = `
                                <div class="list-item-content">
                                    <h3>${event.name}</h3>
                                    <p>Date: ${event.date} | ID: ${event.id}</p>
                                </div>
                                <button class="danger small delete-event-btn" data-id="${event.id}">Delete</button>
                            `;
                            eventList.appendChild(eventEl);
                            
                            const optionEl = document.createElement('option');
                            optionEl.value = event.id;
                            optionEl.textContent = `${event.name} (${event.date})`;
                            optionEl.dataset.name = event.name; 
                            optionEl.dataset.date = event.date; 
                            
                            eventSelect.appendChild(optionEl);
                            eventFilterSelect.appendChild(optionEl.cloneNode(true));
                        });
                        
                        document.querySelectorAll('.delete-event-btn').forEach(btn => {
                            btn.addEventListener('click', () => deleteEvent(btn.dataset.id));
                        });

                    }, (error) => {
                        console.error("Error loading events: ", error);
                        alert("Could not load event data in real time. Error: " + error.message);
                        eventListLoader.style.display = 'none';
                    });

                } catch (error) {
                    console.error("Error setting up event listener: ", error);
                    alert("Failed to set up event listener: " + error.message);
                    eventListLoader.style.display = 'none';
                }
            }
            
            createEventBtn.addEventListener('click', async () => {
                const name = eventNameInput.value.trim();
                const date = eventDateInput.value;
                if (!name || !date) {
                    alert("Please enter both event name and date.");
                    return;
                }
                try {
                    await firebase.addDoc(firebase.collection(db, "events"), {
                        name: name,
                        date: date
                    });
                    eventNameInput.value = '';
                    eventDateInput.value = '';
                } catch (error) {
                    console.error("Error adding event: ", error);
                    alert("Failed to create event: " + error.message);
                }
            });
            
            async function deleteEvent(eventId) {
                if (!confirm("Are you sure you want to delete this event? This will also delete ALL associated tickets.")) {
                    return;
                }
                try {
                    await firebase.deleteDoc(firebase.doc(db, "events", eventId));
                    const ticketsRef = firebase.collection(db, "events", eventId, "tickets");
                    const ticketsQuery = await firebase.getDocs(ticketsRef);
                    const batch = firebase.writeBatch(db);
                    ticketsQuery.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    console.log("Event and all associated tickets deleted successfully.");
                } catch (error) {
                    console.error("Error deleting event: ", error);
                    alert("Failed to delete event and tickets: " + error.message);
                }
            }

            /**
             * Admin: Ticket Management (Manual & Bulk)
             */
            eventFilterSelect.addEventListener('change', () => {
                loadTickets(eventFilterSelect.value);
            });
            
            function loadTickets(eventId) {
                if (currentTicketUnsubscribe) currentTicketUnsubscribe();
                
                if (eventId === 'all' || !eventId) {
                    issuedTicketsList.innerHTML = '<p>Select an event to see issued tickets.</p>';
                    ticketListLoader.style.display = 'none';
                    return;
                }
                
                ticketListLoader.style.display = 'block';
                issuedTicketsList.innerHTML = '';
                
                try {
                    const ticketsRef = firebase.collection(db, "events", eventId, "tickets");
                    currentTicketUnsubscribe = firebase.onSnapshot(ticketsRef, (querySnapshot) => {
                        ticketListLoader.style.display = 'none';
                        issuedTicketsList.innerHTML = '';
                        
                        if (querySnapshot.empty) {
                            issuedTicketsList.innerHTML = '<p>No tickets issued for this event yet.</p>';
                            return;
                        }

                        querySnapshot.forEach((doc) => {
                            const ticket = { id: doc.id, ...doc.data() };
                            const ticketEl = document.createElement('div');
                            ticketEl.className = 'list-item';
                            
                            let status = ticket.scanned 
                                ? `<span style="color: var(--danger-color); font-weight: 600;">Scanned</span>`
                                : `<span style="color: var(--success-color); font-weight: 600;">Valid</span>`;
                            
                            let scannedInfo = ticket.scanned
                                ? `Scanned: ${new Date(ticket.scannedAt.seconds * 1000).toLocaleString()}`
                                : `Email: ${ticket.email}`;
                            
                            ticketEl.innerHTML = `
                                <div class="list-item-content">
                                    <h3>${ticket.name}</h3>
                                    <p>${scannedInfo} | Status: ${status}</p>
                                    <p style="font-size: 0.8rem; color: #888;">Ticket ID: ${ticket.id}</p>
                                    <div class="qr-code-container" id="qr_${ticket.id}" style="margin-top: 15px;"></div>
                                </div>
                            `;
                            issuedTicketsList.appendChild(ticketEl);
                            
                            new QRCode(document.getElementById(`qr_${ticket.id}`), {
                                text: JSON.stringify({ eventId: eventId, ticketId: ticket.id }),
                                width: 128,
                                height: 128
                            });
                        });
                    }, (error) => {
                        console.error("Error loading tickets: ", error);
                        alert("Could not load ticket data in real time.");
                        ticketListLoader.style.display = 'none';
                    });
                } catch (error) {
                    console.error("Error setting up ticket listener: ", error);
                    alert("Failed to set up ticket listener: " + error.message);
                    ticketListLoader.style.display = 'none';
                }
            }

            // Manual Ticket Issuing
            issueTicketBtn.addEventListener('click', async () => {
                const eventId = eventSelect.value;
                const patronName = patronNameInput.value.trim();
                const patronEmail = patronEmailInput.value.trim();
                const quantity = parseInt(patronQuantityInput.value);
                
                if (!eventId || !patronName || !patronEmail || !quantity || quantity < 1) {
                    alert("Please select an event, fill in all patron details, and set a valid quantity.");
                    return;
                }

                const selectedEvent = eventSelect.options[eventSelect.selectedIndex];
                const eventDetails = {
                    id: eventId,
                    name: selectedEvent.dataset.name,
                    date: selectedEvent.dataset.date
                };

                issueTicketBtn.disabled = true;
                issueTicketBtn.textContent = "Issuing...";

                try {
                    const batch = firebase.writeBatch(db);
                    const ticketsRef = firebase.collection(db, "events", eventId, "tickets");
                    const ticketLinks = []; // To store links for the single email
                    
                    for (let i = 1; i <= quantity; i++) {
                        const ticketName = quantity > 1 ? `${patronName} (${i}/${quantity})` : patronName;
                        const newTicketRef = firebase.doc(ticketsRef); // Auto-generates ID
                        
                        batch.set(newTicketRef, {
                            name: ticketName,
                            email: patronEmail,
                            scanned: false,
                            scannedAt: null
                        });
                        
                        const ticketLink = `${window.location.origin}${window.location.pathname}?event=${eventId}&ticket=${newTicketRef.id}`;
                        ticketLinks.push({ id: newTicketRef.id, link: ticketLink, name: ticketName });
                    }
                    
                    await batch.commit(); // Commit all tickets at once
                    
                    // Send one consolidated email
                    await sendTicketEmail({
                        event: eventDetails,
                        email: patronEmail,
                        name: patronName,
                        ticketLinks: ticketLinks // Pass the array of links
                    });

                    alert(`${quantity} ticket(s) successfully issued to ${patronName} and email sent!`);
                    patronNameInput.value = '';
                    patronEmailInput.value = '';
                    patronQuantityInput.value = '1';

                } catch (error) {
                    console.error("Error issuing ticket(s): ", error);
                    alert("Failed to issue ticket(s): " + error.message);
                } finally {
                    issueTicketBtn.disabled = false;
                    issueTicketBtn.textContent = "Issue Ticket(s) & Send Email";
                }
            });
            
            // CSV Bulk Issuing
            processCsvBtn.addEventListener('click', () => {
                const eventId = eventSelect.value;
                if (!eventId) {
                    alert("Please select an event from the 'Issue New Ticket(s)' card above before processing a CSV.");
                    return;
                }
                
                const file = csvFileInput.files[0];
                if (!file) {
                    alert("Please select a CSV file to upload.");
                    return;
                }

                processCsvBtn.disabled = true;
                processCsvBtn.textContent = "Processing...";
                
                Papa.parse(file, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processCsvResults(results.data, eventId);
                    },
                    error: (err) => {
                        alert("Failed to parse CSV file: " + err.message);
                        processCsvBtn.disabled = false;
                        processCsvBtn.textContent = "Process CSV & Send Tickets";
                    }
                });
            });
            
            async function processCsvResults(rows, eventId) {
                const selectedEvent = eventSelect.options[eventSelect.selectedIndex];
                const eventDetails = {
                    id: eventId,
                    name: selectedEvent.dataset.name,
                    date: selectedEvent.dataset.date
                };
                
                let successCount = 0;
                let errorCount = 0;
                
                csvProgress.innerHTML = `
                    <p>Processing ${rows.length} rows... (0% complete)</p>
                    <div class="progress-bar"><div class="progress-bar-inner" id="csvProgressBar"></div></div>
                `;
                const progressBar = document.getElementById('csvProgressBar');

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    try {
                        const name = row[0] ? row[0].trim() : null;
                        const email = row[1] ? row[1].trim() : null;
                        const quantity = parseInt(row[2]);

                        if (!name || !email || !quantity || quantity < 1) {
                            throw new Error(`Skipping row ${i+1}: Invalid data. (Name: ${name}, Email: ${email}, Qty: ${quantity})`);
                        }

                        // Create tickets in a batch
                        const batch = firebase.writeBatch(db);
                        const ticketsRef = firebase.collection(db, "events", eventId, "tickets");
                        const ticketLinks = [];
                        
                        for (let j = 1; j <= quantity; j++) {
                            const ticketName = quantity > 1 ? `${name} (${j}/${quantity})` : name;
                            const newTicketRef = firebase.doc(ticketsRef);
                            
                            batch.set(newTicketRef, {
                                name: ticketName,
                                email: email,
                                scanned: false,
                                scannedAt: null
                            });
                            
                            const ticketLink = `${window.location.origin}${window.location.pathname}?event=${eventId}&ticket=${newTicketRef.id}`;
                            ticketLinks.push({ id: newTicketRef.id, link: ticketLink, name: ticketName });
                        }
                        
                        await batch.commit(); // Save tickets to Firestore
                        
                        // Send consolidated email
                        await sendTicketEmail({
                            event: eventDetails,
                            email: email,
                            name: name,
                            ticketLinks: ticketLinks
                        });
                        
                        successCount++;

                    } catch (error) {
                        console.error(error.message);
                        errorCount++;
                    }
                    
                    // Update progress
                    const percent = ((i + 1) / rows.length) * 100;
                    progressBar.style.width = `${percent}%`;
                    csvProgress.querySelector('p').textContent = `Processing ${rows.length} rows... (${Math.round(percent)}% complete) | Success: ${successCount}, Failed: ${errorCount}`;
                }

                // Final report
                csvProgress.innerHTML = `Processing Complete! <strong>${successCount}</strong> emails sent (for ${rows.length} rows). <strong>${errorCount}</strong> rows failed.`;
                processCsvBtn.disabled = false;
                processCsvBtn.textContent = "Process CSV & Send Tickets";
                csvFileInput.value = ''; // Clear the file input
            }

            // Standardized Email Function
            async function sendTicketEmail(data) {
                // data = { event, email, name, ticketLinks: [] }
                if (EMAIL_SERVICE_URL === "YOUR_GOOGLE_APPS_SCRIPT_URL") {
                    console.warn("Email sending skipped: EMAIL_SERVICE_URL is not set.");
                    throw new Error("Email sending failed (Admin setup incomplete). Ticket(s) were created, but no email was sent.");
                }
                try {
                    const response = await fetch(EMAIL_SERVICE_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(data), // Send the whole object
                        redirect: 'follow'
                    });
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || "Unknown email service error");
                    }
                    console.log("Email service success:", result.message);
                } catch (error) {
                    console.error("Error calling email service:", error);
                    throw new Error(`Ticket(s) were created, but email failed to send: ${error.message}`);
                }
            }
            
            /**
             * Ticket Viewer (External Link)
             */
            async function loadTicketData(eventId, ticketId) {
                ticketDetails.style.display = 'none';
                ticketDetailsLoader.style.display = 'block';
                ticketQRCode.innerHTML = "";
                
                try {
                    const eventRef = firebase.doc(db, "events", eventId);
                    const eventSnap = await firebase.getDoc(eventRef);
                    if (!eventSnap.exists()) throw new Error("Event not found.");
                    const event = eventSnap.data();
                    
                    const ticketRef = firebase.doc(db, "events", eventId, "tickets", ticketId);
                    const ticketSnap = await firebase.getDoc(ticketRef);
                    if (!ticketSnap.exists()) throw new Error("Ticket not found.");
                    const ticket = ticketSnap.data();

                    ticketEventName.textContent = event.name;
                    ticketEventDate.textContent = `On ${event.date}`;
                    ticketPatronName.textContent = ticket.name;
                    ticketIdDisplay.textContent = `Ticket ID: ${ticketId}`;
                    
                    if(ticket.scanned) {
                        ticketStatus.className = 'invalid';
                        ticketStatus.textContent = `This ticket was already scanned on ${new Date(ticket.scannedAt.seconds * 1000).toLocaleString()}`;
                    } else {
                        ticketStatus.className = 'valid';
                        ticketStatus.textContent = "This ticket is valid for entry.";
                    }

                    new QRCode(ticketQRCode, {
                        text: JSON.stringify({ eventId: eventId, ticketId: ticketId }),
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff"
                    });

                    ticketDetailsLoader.style.display = 'none';
                    ticketDetails.style.display = 'block';

                } catch (error) {
                    console.error("Error loading ticket:", error);
                    ticketDetailsLoader.style.display = 'none';
                    ticketDetails.style.display = 'block';
                    ticketEventName.textContent = "Error";
                    ticketPatronName.textContent = error.message;
                    ticketStatus.className = 'invalid';
                    ticketStatus.textContent = "Could not load ticket data.";
                }
            }

            /**
             * Scanner (Continuous)
             */
            function startScanner() {
                if (isScanning) return; 
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.setAttribute("playsinline", true);
                        video.play();
                        
                        scanResult.style.display = 'block';
                        scanResult.className = 'info';
                        scanResult.textContent = 'Ready to scan';
                        
                        isScanning = true;
                        scanner = requestAnimationFrame(tick); 
                    })
                    .catch(err => {
                        console.error("Camera Error:", err);
                        alert("Could not access camera. Please grant permission.");
                        isScanning = false;
                    });
            }

            function stopScanner() {
                isScanning = false;
                if (scanner) {
                    cancelAnimationFrame(scanner);
                    scanner = null;
                }
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
            }
            
            function tick() {
                if (!isScanning) return; 

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const canvasElement = document.createElement('canvas');
                    const canvas = canvasElement.getContext('2d');
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                    
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        isScanning = false; 
                        handleScannedCode(code.data);
                    }
                }
                
                if (isScanning) { 
                    scanner = requestAnimationFrame(tick);
                }
            }

            async function handleScannedCode(data) {
                scanResult.style.display = 'block';
                
                let parsedData;
                try {
                    parsedData = JSON.parse(data);
                    if (!parsedData.eventId || !parsedData.ticketId) {
                        throw new Error("Invalid QR code format.");
                    }
                } catch (error) {
                    console.error("QR Parse Error:", error);
                    scanResult.className = 'error'; // Red
                    scanResult.textContent = "Invalid QR Code. Not a valid ticket.";
                    playSound('invalid');
Next, I would like to be able to scan a QR code from an image or screenshot that someone has, because not all people will have their QR code in person or will be able to pull it up on their phone, sometimes they just have a screenshot.                    restartScanner(4000); 
                    return;
                }

                const { eventId, ticketId } = parsedData;
                scanResult.className = 'info'; 
                scanResult.textContent = `Found Ticket ID: ${ticketId}. Verifying...`;

                try {
                    const ticketRef = firebase.doc(db, "events", eventId, "tickets", ticketId);
                    const ticketSnap = await firebase.getDoc(ticketRef);

                    if (!ticketSnap.exists()) {
                        scanResult.className = 'error'; // Red
                        scanResult.textContent = `Verification Error: Ticket (ID: ${ticketId}) does not exist.`;
                        playSound('invalid');
                        restartScanner(4000);
                        return;
                    }

                    const ticket = ticketSnap.data();

                    if (ticket.scanned) {
                        scanResult.className = 'warn'; // Orange
                        scanResult.textContent = `Ticket Already Scanned: ${ticket.name}'s ticket was scanned at ${new Date(ticket.scannedAt.seconds * 1000).toLocaleString()}.`;
                        playSound('invalid');
                        restartScanner(4000);
                        return;
                    }

                    await firebase.updateDoc(ticketRef, {
                        scanned: true,
                        scannedAt: firebase.serverTimestamp()
                    });
                    
                    scanResult.className = 'success'; // Green
                    scanResult.textContent = `Success! Ticket for ${ticket.name} is valid and now marked as scanned.`;
                    playSound('valid');
                    restartScanner(4000);

                } catch (error) {
                    console.error("Verification Error:", error);
                    scanResult.className = 'error'; // Red
                    scanResult.textContent = `Verification Error: ${error.message}`;
                    playSound('invalid');
                    restartScanner(4000);
                }
            }
            
            function restartScanner(cooldown) {
                setTimeout(() => {
                    scanResult.className = 'info';
                    scanResult.textContent = 'Ready to scan';
                    
                    if (currentView === 'scanner') { 
                        isScanning = true;
                        scanner = requestAnimationFrame(tick);
                    }
                }, cooldown);
            }
            
            // Start the app
            initFirebase();

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>
